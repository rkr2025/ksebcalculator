<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìò Solar Diary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box; /* Ensure padding/margins don't cause overflow */
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #2980b9, #6dd5fa);
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 960px;
      margin: 10px auto; /* Reduced margin for mobile */
      background: white;
      padding: 15px; /* Reduced padding */
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      width: 100%; /* Ensure container doesn't exceed viewport */
    }
    h2, h3 {
      text-align: center;
      font-size: 24px; /* Default for h2 */
      margin: 10px 0;
      overflow-wrap: break-word; /* Prevent long text overflow */
    }
    h3 {
      font-size: 18px; /* Smaller for h3 */
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Reduced min width */
      gap: 8px; /* Smaller gap for mobile */
      margin-bottom: 15px;
      width: 100%;
    }
    input {
      padding: 6px; /* Reduced padding */
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      font-size: 14px;
    }
    button {
      padding: 8px; /* Reduced padding */
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      max-width: 100%; /* Prevent button overflow */
    }
    button:hover {
      background: #2980b9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
      font-size: 14px;
    }
    .highlight {
      background-color: #ecf0f1;
      font-weight: bold;
    }
    .edit-btn, .delete-btn {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
    .edit-btn { color: #2980b9; }
    .delete-btn { color: #e74c3c; }
    .nav-link {
      display: block;
      text-align: center;
      margin-top: 15px;
      text-decoration: none;
      color: #3498db;
      font-size: 14px;
    }
    .center {
      text-align: center;
      margin: 8px 0;
    }
    .table-container {
      overflow-x: auto;
      width: 100%;
    }
    #initialValuesDisplay {
      font-size: 14px;
      text-align: center;
      margin-bottom: 10px;
      overflow-wrap: break-word; /* Prevent long text overflow */
    }
    #backupSection {
      display: flex;
      flex-wrap: wrap; /* Allow wrapping for mobile */
      justify-content: center;
      gap: 8px; /* Space between elements */
    }
    #backupSection input[type="file"] {
      font-size: 12px;
      max-width: 150px; /* Limit file input width */
    }
    /* Print-specific styles */
    @media print {
      body {
        background: none;
        margin: 0;
      }
      .container {
        margin: 0;
        padding: 10px;
        box-shadow: none;
      }
      h2, h3, form, .center, .nav-link, #backupSection {
        display: none;
      }
      .table-container {
        overflow-x: visible;
      }
      table {
        width: 100%;
        font-size: 12px;
      }
      th, td {
        padding: 4px;
        border: 1px solid #000;
      }
    }
    /* Responsive styles for mobile */
    @media (max-width: 480px) {
      .container {
        padding: 10px;
        margin: 5px;
      }
      h2 {
        font-size: 20px;
      }
      h3 {
        font-size: 16px;
      }
      form {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); /* Further reduced */
        gap: 6px;
      }
      input {
        padding: 5px;
        font-size: 12px;
      }
      button {
        padding: 6px;
        font-size: 12px;
      }
      th, td {
        padding: 4px;
        font-size: 12px;
        min-width: 55px; /* Slightly reduced */
      }
      .edit-btn, .delete-btn {
        font-size: 14px;
      }
      .nav-link {
        font-size: 12px;
      }
      #initialValuesDisplay {
        font-size: 12px;
      }
      #backupSection input[type="file"] {
        max-width: 120px;
      }
    }
    @media (max-width: 360px) {
      .container {
        padding: 8px;
        margin: 3px;
      }
      h2 {
        font-size: 18px;
      }
      h3 {
        font-size: 14px;
      }
      form {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 5px;
      }
      input {
        padding: 4px;
        font-size: 11px;
      }
      button {
        padding: 5px;
        font-size: 11px;
      }
      th, td {
        padding: 3px;
        font-size: 10px;
        min-width: 50px;
      }
      .edit-btn, .delete-btn {
        font-size: 12px;
      }
      .nav-link {
        font-size: 11px;
      }
      #initialValuesDisplay {
        font-size: 11px;
      }
      #backupSection input[type="file"] {
        max-width: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìò Solar Diary</h2>
    <h3 id="initialReadingHeading">üîë June month Initial Reading</h3>
    <form id="initialForm">
      <input type="number" id="init_solar" placeholder="Initial Solar Gen">
      <input type="number" id="init_t1" placeholder="Initial T1">
      <input type="number" id="init_t2" placeholder="Initial T2">
      <input type="number" id="init_t3" placeholder="Initial T3">
      <input type="number" id="init_export" placeholder="Initial Export">
      <button type="submit">üíæ Save Initial</button>
    </form>
    <div id="initialValuesDisplay"></div>
    <div class="center">
      <button onclick="deleteInitial()">üóëÔ∏è Delete Initial Readings</button>
    </div>
    <h3>‚ûï Current Solar Readings</h3>
    <form id="diaryForm">
      <input type="number" id="solar" placeholder="Solar Gen" required>
      <input type="number" id="t1" placeholder="T1" required>
      <input type="number" id="t2" placeholder="T2" required>
      <input type="number" id="t3" placeholder="T3" required>
      <input type="number" id="export" placeholder="Export" required>
      <button type="submit">‚ûï Add</button>
    </form>
    <h3>üìã Entries Log</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Solar</th>
            <th>T1</th>
            <th>T2</th>
            <th>T3</th>
            <th>Export</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="entriesBody"></tbody>
      </table>
    </div>
    <div id="backupSection" class="center">
      <button onclick="backupReadings()">üíæ Backup Readings</button>
      <input type="file" id="restoreFile" accept=".json" style="margin: 10px;">
      <button onclick="restoreReadings()">üìÇ Restore Readings</button>
    </div>
    <div class="center">
      <button onclick="generatePrintableReport()">üñ®Ô∏è Generate Printable Report</button>
    </div>
    <a href="index.html" class="nav-link">‚Üê Back to Calculator</a>
  </div>
  <script>
    // Set current month in the initial reading heading
    document.addEventListener('DOMContentLoaded', () => {
      const monthHeading = document.getElementById('initialReadingHeading');
      const currentMonth = new Date().toLocaleString('en-US', { month: 'long' });
      monthHeading.textContent = `üîë ${currentMonth} month Initial Reading`;
    });

    let initialReadings = JSON.parse(localStorage.getItem("initialReadings")) || null;
    let entries = JSON.parse(localStorage.getItem("entries")) || [];

    function displayInitialValues() {
      const el = document.getElementById("initialValuesDisplay");
      if (!initialReadings) {
        el.innerHTML = '<em>No initial readings saved.</em>';
      } else {
        el.innerHTML = `
          <strong>Saved Initial Readings:</strong><br>
          Solar: ${initialReadings.solar}, T1: ${initialReadings.t1},
          T2: ${initialReadings.t2}, T3: ${initialReadings.t3}, Export: ${initialReadings.export}
        `;
      }
    }

    function updateStorage() {
      localStorage.setItem("initialReadings", JSON.stringify(initialReadings));
      localStorage.setItem("entries", JSON.stringify(entries));
    }

    function renderEntries() {
      const tbody = document.getElementById("entriesBody");
      tbody.innerHTML = "";

      let total = { solar: 0, t1: 0, t2: 0, t3: 0, export: 0 };

      entries.forEach((e, i) => {
        const delta = initialReadings ? {
          solar: e.solar - initialReadings.solar,
          t1: e.t1 - initialReadings.t1,
          t2: e.t2 - initialReadings.t2,
          t3: e.t3 - initialReadings.t3,
          export: e.export - initialReadings.export
        } : null;

        total.solar += delta ? delta.solar : e.solar;
        total.t1 += delta ? delta.t1 : e.t1;
        total.t2 += delta ? delta.t2 : e.t2;
        total.t3 += delta ? delta.t3 : e.t3;
        total.export += delta ? delta.export : e.export;

        tbody.innerHTML += `<tr>
          <td>${e.date}</td>
          <td>${e.solar}</td><td>${e.t1}</td><td>${e.t2}</td><td>${e.t3}</td><td>${e.export}</td>
          <td>
            <button class="edit-btn" onclick="editEntry(${i})">‚úèÔ∏è</button>
            <button class="delete-btn" onclick="deleteEntry(${i})">üóëÔ∏è</button>
          </td>
        </tr>`;
      });

      if (entries.length > 0) {
        const lastEntry = entries[entries.length - 1];
        const usage = initialReadings ? {
          solar: lastEntry.solar - initialReadings.solar,
          t1: lastEntry.t1 - initialReadings.t1,
          t2: lastEntry.t2 - initialReadings.t2,
          t3: lastEntry.t3 - initialReadings.t3,
          export: lastEntry.export - initialReadings.export
        } : {
          solar: lastEntry.solar,
          t1: lastEntry.t1,
          t2: lastEntry.t2,
          t3: lastEntry.t3,
          export: lastEntry.export
        };

        tbody.innerHTML += `<tr class="highlight">
          <td><strong>Total Usage</strong></td>
          <td>${Math.round(usage.solar)}</td>
          <td>${Math.round(usage.t1)}</td>
          <td>${Math.round(usage.t2)}</td>
          <td>${Math.round(usage.t3)}</td>
          <td>${Math.round(usage.export)}</td>
          <td></td>
        </tr>`;
      }
    }

    function deleteInitial() {
      initialReadings = null;
      localStorage.removeItem("initialReadings");
      displayInitialValues();
      renderEntries();
    }

    document.getElementById("initialForm").addEventListener("submit", e => {
      e.preventDefault();
      initialReadings = {
        solar: parseFloat(document.getElementById("init_solar").value) || 0,
        t1: parseFloat(document.getElementById("init_t1").value) || 0,
        t2: parseFloat(document.getElementById("init_t2").value) || 0,
        t3: parseFloat(document.getElementById("init_t3").value) || 0,
        export: parseFloat(document.getElementById("init_export").value) || 0
      };
      updateStorage();
      displayInitialValues();
      renderEntries();
      e.target.reset();
    });

    document.getElementById("diaryForm").addEventListener("submit", e => {
      e.preventDefault();
      const entry = {
        date: new Date().toLocaleString(),
        solar: parseFloat(document.getElementById("solar").value),
        t1: parseFloat(document.getElementById("t1").value),
        t2: parseFloat(document.getElementById("t2").value),
        t3: parseFloat(document.getElementById("t3").value),
        export: parseFloat(document.getElementById("export").value)
      };
      entries.push(entry);
      updateStorage();
      renderEntries();
      e.target.reset();
    });

    function deleteEntry(i) {
      entries.splice(i, 1);
      updateStorage();
      renderEntries();
    }

    function editEntry(i) {
      const e = entries[i];
      document.getElementById("solar").value = e.solar;
      document.getElementById("t1").value = e.t1;
      document.getElementById("t2").value = e.t2;
      document.getElementById("t3").value = e.t3;
      document.getElementById("export").value = e.export;
      entries.splice(i, 1);
      updateStorage();
      renderEntries();
    }

    // Backup Readings
    function backupReadings() {
      const data = { initialReadings, entries };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `solar_diary_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Restore Readings
    function restoreReadings() {
      const fileInput = document.getElementById('restoreFile');
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select a JSON file to restore.');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.initialReadings) {
            initialReadings = data.initialReadings;
            localStorage.setItem('initialReadings', JSON.stringify(initialReadings));
          }
          if (data.entries) {
            entries = data.entries;
            localStorage.setItem('entries', JSON.stringify(entries));
          }
          displayInitialValues();
          renderEntries();
          alert('Readings restored successfully!');
        } catch (err) {
          alert('Error restoring readings: Invalid JSON file.');
        }
      };
      reader.readAsText(file);
      fileInput.value = '';
    }

    // Generate Printable Report
    function generatePrintableReport() {
      window.print();
    }

    displayInitialValues();
    renderEntries();
  </script>
</body>
</html>
