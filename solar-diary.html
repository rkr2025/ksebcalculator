<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üìò Solar Diary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #2980b9, #6dd5fa);
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 960px;
      margin: 10px auto;
      background: white;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      width: 100%;
    }
    h2, h3 {
      text-align: center;
      font-size: 24px;
      margin: 10px 0;
      overflow-wrap: break-word;
    }
    h3 {
      font-size: 18px;
    }
    h4 {
      font-size: 16px;
      margin: 10px 0;
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
      margin-bottom: 15px;
      width: 100%;
    }
    input {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
      font-size: 14px;
    }
    button {
      padding: 8px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      max-width: 100%;
    }
    button:hover {
      background: #2980b9;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: center;
      font-size: 14px;
    }
    .highlight {
      background-color: #ecf0f1;
      font-weight: bold;
    }
    .edit-btn, .delete-btn {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }
    .edit-btn { color: #2980b9; }
    .delete-btn { color: #e74c3c; }
    .nav-link {
      display: block;
      text-align: center;
      margin-top: 15px;
      text-decoration: none;
      color: #3498db;
      font-size: 14px;
    }
    .center {
      text-align: center;
      margin: 8px 0;
    }
    .table-container {
      overflow-x: auto;
      width: 100%;
    }
    #initialValuesDisplay {
      font-size: 14px;
      margin-bottom: 10px;
    }
    #usageInsights, #usageAnalysis {
      margin-top: 10px;
      text-align: left;
      font-size: 14px;
      max-width: 100%;
      padding: 0 10px;
    }
    #usageInsights .warning {
      color: #e74c3c;
      font-weight: bold;
    }
    #usageInsights .safe {
      color: #2ecc71;
      font-weight: bold;
    }
    #usageInsights .advice {
      color: #7f8c8d;
      font-style: italic;
    }
    #usageAnalysis ul {
      margin: 5px 0;
      padding-left: 20px;
    }
    #usageAnalysis li {
      margin-bottom: 5px;
    }
    #backupSection {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    #backupSection input[type="file"] {
      font-size: 12px;
      max-width: 150px;
    }
    #backupSection button, #backupSection input[type="file"] {
      width: 100%;
      max-width: 200px;
    }
    /* Print-specific styles */
    @media print {
      body {
        background: none;
        margin: 0;
      }
      .container {
        margin: 0;
        padding: 10px;
        box-shadow: none;
      }
      h2, h3, h4, form, .center, .nav-link, #backupSection, #initialValuesDisplay, #usageInsights, #usageAnalysis {
        display: none;
      }
      .table-container {
        overflow-x: visible;
      }
      table {
        width: 100%;
        font-size: 12px;
      }
      th, td {
        padding: 4px;
        border: 1px solid #000;
      }
    }
    /* Responsive styles for mobile */
    @media (max-width: 480px) {
      .container {
        padding: 10px;
        margin: 5px;
      }
      h2 {
        font-size: 20px;
      }
      h3 {
        font-size: 16px;
      }
      h4 {
        font-size: 14px;
      }
      form {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
        gap: 6px;
      }
      input {
        padding: 5px;
        font-size: 12px;
      }
      button {
        padding: 6px;
        font-size: 12px;
      }
      th, td {
        padding: 4px;
        font-size: 12px;
        min-width: 55px;
      }
      .edit-btn, .delete-btn {
        font-size: 14px;
      }
      .nav-link {
        font-size: 12px;
      }
      #initialValuesDisplay, #usageInsights, #usageAnalysis {
        font-size: 12px;
      }
      #backupSection {
        flex-direction: column;
        align-items: center;
      }
      #backupSection input[type="file"] {
        max-width: 120px;
      }
      #backupSection button, #backupSection input[type="file"] {
        max-width: 150px;
      }
    }
    @media (max-width: 360px) {
      .container {
        padding: 8px;
        margin: 3px;
      }
      h2 {
        font-size: 18px;
      }
      h3 {
        font-size: 14px;
      }
      h4 {
        font-size: 12px;
      }
      form {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 5px;
      }
      input {
        padding: 4px;
        font-size: 11px;
      }
      button {
        padding: 5px;
        font-size: 11px;
      }
      th, td {
        padding: 3px;
        font-size: 10px;
        min-width: 50px;
      }
      .edit-btn, .delete-btn {
        font-size: 12px;
      }
      .nav-link {
        font-size: 11px;
      }
      #initialValuesDisplay, #usageInsights, #usageAnalysis {
        font-size: 11px;
      }
      #backupSection input[type="file"] {
        max-width: 100px;
      }
      #backupSection button, #backupSection input[type="file"] {
        max-width: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìò Solar Diary</h2>
    <h3 id="initialReadingHeading">üîë June month Initial Reading</h3>
    <form id="initialForm">
      <input type="number" id="init_solar" placeholder="Initial Solar Gen">
      <input type="number" id="init_t1" placeholder="Initial T1">
      <input type="number" id="init_t2" placeholder="Initial T2">
      <input type="number" id="init_t3" placeholder="Initial T3">
      <input type="number" id="init_export" placeholder="Initial Export">
      <button type="submit">üíæ Save Initial</button>
    </form>
    <div id="initialValuesDisplay"></div>
    <hr>
    <h3  style="margin-top: 25px;">‚ûï Current Solar Readings</h3>
    <form id="diaryForm">
      <input type="number" id="solar" placeholder="Solar Gen" required>
      <input type="number" id="t1" placeholder="T1" required>
      <input type="number" id="t2" placeholder="T2" required>
      <input type="number" id="t3" placeholder="T3" required>
      <input type="number" id="export" placeholder="Export" required>
      <button type="submit">‚ûï Add</button>
    </form>
    <h3>üìã Entries Log</h3>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Solar</th>
            <th>T1</th>
            <th>T2</th>
            <th>T3</th>
            <th>Export</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="entriesBody"></tbody>
      </table>
    </div>
    <div id="usageInsights"></div>
    <div id="usageAnalysis"></div>
    <div id="backupSection" class="center">
      <button onclick="backupReadings()">üíæ Backup Readings</button>
      <input type="file" id="restoreFile" accept=".json" style="margin: 10px;">
      <button onclick="restoreReadings()">üìÇ Restore Readings</button>
    </div>
    <div class="center">
      <button onclick="generatePrintableReport()">üñ®Ô∏è Generate Printable Report</button>
    </div>
    <a href="index.html" class="nav-link">‚Üê Back to Calculator</a>
  </div>
  <script>
    // Set current month in the initial reading heading
    document.addEventListener('DOMContentLoaded', () => {
      const monthHeading = document.getElementById('initialReadingHeading');
      const currentMonth = new Date().toLocaleString('en-US', { month: 'long' });
      monthHeading.textContent = `üîë ${currentMonth} month Initial Reading`;
    });

    let initialReadings = JSON.parse(localStorage.getItem("initialReadings")) || null;
    let entries = JSON.parse(localStorage.getItem("entries")) || [];

    function displayInitialValues() {
      const el = document.getElementById("initialValuesDisplay");
      if (!initialReadings) {
        el.innerHTML = '<em>No initial readings saved.</em>';
      } else {
        el.innerHTML = `
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Solar</th>
                  <th>T1</th>
                  <th>T2</th>
                  <th>T3</th>
                  <th>Export</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${initialReadings.solar}</td>
                  <td>${initialReadings.t1}</td>
                  <td>${initialReadings.t2}</td>
                  <td>${initialReadings.t3}</td>
                  <td>${initialReadings.export}</td>
                  <td>
                    <button class="delete-btn" onclick="deleteInitial()">üóëÔ∏è</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      }
    }

    function updateStorage() {
      localStorage.setItem("initialReadings", JSON.stringify(initialReadings));
      localStorage.setItem("entries", JSON.stringify(entries));
    }

    function renderEntries() {
      const tbody = document.getElementById("entriesBody");
      const insightsEl = document.getElementById("usageInsights");
      const analysisEl = document.getElementById("usageAnalysis");
      tbody.innerHTML = "";
      insightsEl.innerHTML = "";
      analysisEl.innerHTML = "";

      let total = { solar: 0, t1: 0, t2: 0, t3: 0, export: 0 };

      entries.forEach((e, i) => {
        const delta = initialReadings ? {
          solar: e.solar - initialReadings.solar,
          t1: e.t1 - initialReadings.t1,
          t2: e.t2 - initialReadings.t2,
          t3: e.t3 - initialReadings.t3,
          export: e.export - initialReadings.export
        } : null;

        total.solar += delta ? delta.solar : e.solar;
        total.t1 += delta ? delta.t1 : e.t1;
        total.t2 += delta ? delta.t2 : e.t2;
        total.t3 += delta ? delta.t3 : e.t3;
        total.export += delta ? delta.export : e.export;

        tbody.innerHTML += `<tr>
          <td>${e.date}</td>
          <td>${e.solar}</td><td>${e.t1}</td><td>${e.t2}</td><td>${e.t3}</td><td>${e.export}</td>
          <td>
            <button class="edit-btn" onclick="editEntry(${i})">‚úèÔ∏è</button>
            <button class="delete-btn" onclick="deleteEntry(${i})">üóëÔ∏è</button>
          </td>
        </tr>`;
      });

      if (entries.length > 0) {
        const lastEntry = entries[entries.length - 1];
        const usage = initialReadings ? {
          solar: lastEntry.solar - initialReadings.solar,
          t1: lastEntry.t1 - initialReadings.t1,
          t2: lastEntry.t2 - initialReadings.t2,
          t3: lastEntry.t3 - initialReadings.t3,
          export: lastEntry.export - initialReadings.export
        } : {
          solar: lastEntry.solar,
          t1: lastEntry.t1,
          t2: lastEntry.t2,
          t3: lastEntry.t3,
          export: lastEntry.export
        };

        tbody.innerHTML += `<tr class="highlight">
          <td><strong>Total Usage</strong></td>
          <td>${Math.round(usage.solar)}</td>
          <td>${Math.round(usage.t1)}</td>
          <td>${Math.round(usage.t2)}</td>
          <td>${Math.round(usage.t3)}</td>
          <td>${Math.round(usage.export)}</td>
          <td></td>
        </tr>`;

        // Usage Insights
        const totalConsumption = usage.t1 + usage.t2 + usage.t3;
        const exportUnits = usage.export;
        let insightsHTML = '';

        if (totalConsumption > exportUnits) {
          const difference = Math.round(totalConsumption - exportUnits);
          insightsHTML += `<p class="warning">Warning: You are using ${difference} units more than exported. These units will be charged. Please reduce your electricity usage.</p>`;
          insightsHTML += `<p class="advice">Advice: Reduce your usage by ${difference} units to keep T1 + T2 + T3 at or below Export levels.</p>`;
        } else {
          const difference = Math.round(exportUnits - totalConsumption);
          insightsHTML += `<p class="safe">Good: You have ${difference} units available to use safely this month.</p>`;
        }

        insightsEl.innerHTML = insightsHTML;

        // Data Analysis and Recommendations
        let analysisHTML = '<h4>Usage Analysis & Recommendations</h4>';
        let avgT1 = 0, avgT2 = 0, avgT3 = 0, avgExport = 0;
        let excessCount = 0;

        // Calculate averages and track excess consumption
        entries.forEach(e => {
          const eUsage = initialReadings ? {
            t1: e.t1 - initialReadings.t1,
            t2: e.t2 - initialReadings.t2,
            t3: e.t3 - initialReadings.t3,
            export: e.export - initialReadings.export
          } : {
            t1: e.t1,
            t2: e.t2,
            t3: e.t3,
            export: e.export
          };
          avgT1 += eUsage.t1;
          avgT2 += eUsage.t2;
          avgT3 += eUsage.t3;
          avgExport += eUsage.export;
          if ((eUsage.t1 + eUsage.t2 + eUsage.t3) > eUsage.export) {
            excessCount++;
          }
        });

        avgT1 /= entries.length;
        avgT2 /= entries.length;
        avgT3 /= entries.length;
        avgExport /= entries.length;

        // Cost-weighted calculations (T1: 0.9, T2: 1.25, T3: 1.0)
        const totalAvgConsumption = avgT1 + avgT2 + avgT3;
        const costWeightedConsumption = avgT1 * 0.9 + avgT2 * 1.25 + avgT3 * 1.0;
        const contributions = [
          { meter: 'T1', value: avgT1, costValue: avgT1 * 0.9, percent: costWeightedConsumption ? (avgT1 * 0.9 / costWeightedConsumption * 100).toFixed(1) : 0 },
          { meter: 'T2', value: avgT2, costValue: avgT2 * 1.25, percent: costWeightedConsumption ? (avgT2 * 1.25 / costWeightedConsumption * 100).toFixed(1) : 0 },
          { meter: 'T3', value: avgT3, costValue: avgT3 * 1.0, percent: costWeightedConsumption ? (avgT3 * 1.0 / costWeightedConsumption * 100).toFixed(1) : 0 }
        ];
        const highestCostMeter = contributions.reduce((max, curr) => max.costValue > curr.costValue ? max : curr);

        analysisHTML += '<ul>';
        analysisHTML += `<li><strong>Usage Pattern</strong>: Your average monthly consumption is ${Math.round(totalAvgConsumption)} units (T1: ${Math.round(avgT1)} units, T2: ${Math.round(avgT2)} units, T3: ${Math.round(avgT3)} units), compared to an average export of ${Math.round(avgExport)} units.</li>`;
        analysisHTML += `<li><strong>Highest Cost Meter</strong>: ${highestCostMeter.meter} contributes ${highestCostMeter.percent}% to your potential charges (T1: ${contributions.find(c => c.meter === 'T1').percent}%, T2: ${contributions.find(c => c.meter === 'T2').percent}%, T3: ${contributions.find(c => c.meter === 'T3').percent}%).</li>`;
        if (excessCount > entries.length / 2) {
          analysisHTML += `<li><strong>Trend</strong>: You exceeded export in ${excessCount} of ${entries.length} entries, indicating frequent high usage that may lead to higher charges.</li>`;
        } else {
          analysisHTML += `<li><strong>Trend</strong>: You stayed below or near export in most entries, but monitor usage to avoid charges.</li>`;
        }

        analysisHTML += '<li><strong>Recommendations</strong>:';
        analysisHTML += '<ul>';
        if (totalConsumption > exportUnits) {
          const excess = Math.round(totalConsumption - exportUnits);
          analysisHTML += `<li>Reduce total usage by ${excess} units to match or stay below export levels to avoid charges.</li>`;
          if (highestCostMeter.meter === 'T2') {
            analysisHTML += `<li><strong>Focus on T2</strong>: T2 is charged at 125% of the prevailing rate and contributes ${highestCostMeter.percent}% to costs. Reduce high-power appliance usage (e.g., air conditioners, heaters) during peak hours or switch to energy-efficient models.</li>`;
          } else if (highestCostMeter.meter === 'T1') {
            analysisHTML += `<li><strong>Focus on T1</strong>: T1 contributes ${highestCostMeter.percent}% to costs, despite its lower rate (90%). Optimize usage by turning off unnecessary devices or shifting loads to off-peak times.</li>`;
          } else {
            analysisHTML += `<li><strong>Focus on T3</strong>: T3 contributes ${highestCostMeter.percent}% to costs. Check for inefficient devices (e.g., old lighting or appliances) and reduce their usage.</li>`;
          }
        } else if (totalConsumption > exportUnits * 0.9) {
          analysisHTML += `<li>Your usage is close to export (${Math.round(totalConsumption/exportUnits*100)}% of export). Make minor reductions, especially on T2 (125% rate), by turning off unused devices or using energy-saving modes.</li>`;
        } else {
          analysisHTML += `<li>Your usage is well below export. Continue monitoring T2 (125% rate) to maintain cost efficiency.</li>`;
        }
        analysisHTML += `<li>Maximize export: Clean solar panels and ensure they are unobstructed to increase export units, offsetting any charged consumption.</li>`;
        if (highestCostMeter.meter !== 'T2') {
          analysisHTML += `<li>Monitor T2: Its high rate (125%) can significantly increase costs if usage rises. Ensure no unnecessary devices are running on T2 circuits.</li>`;
        }
        analysisHTML += '</ul></li>';
        analysisHTML += '</ul>';

        analysisEl.innerHTML = analysisHTML;
      }
    }

    function deleteInitial() {
      initialReadings = null;
      localStorage.removeItem("initialReadings");
      displayInitialValues();
      renderEntries();
    }

    document.getElementById("initialForm").addEventListener("submit", e => {
      e.preventDefault();
      initialReadings = {
        solar: parseFloat(document.getElementById("init_solar").value) || 0,
        t1: parseFloat(document.getElementById("init_t1").value) || 0,
        t2: parseFloat(document.getElementById("init_t2").value) || 0,
        t3: parseFloat(document.getElementById("init_t3").value) || 0,
        export: parseFloat(document.getElementById("init_export").value) || 0
      };
      updateStorage();
      displayInitialValues();
      renderEntries();
      e.target.reset();
    });

    document.getElementById("diaryForm").addEventListener("submit", e => {
      e.preventDefault();
      const entry = {
        date: new Date().toLocaleString(),
        solar: parseFloat(document.getElementById("solar").value),
        t1: parseFloat(document.getElementById("t1").value),
        t2: parseFloat(document.getElementById("t2").value),
        t3: parseFloat(document.getElementById("t3").value),
        export: parseFloat(document.getElementById("export").value)
      };
      entries.push(entry);
      updateStorage();
      renderEntries();
      e.target.reset();
    });

    function deleteEntry(i) {
      entries.splice(i, 1);
      updateStorage();
      renderEntries();
    }

    function editEntry(i) {
      const e = entries[i];
      document.getElementById("solar").value = e.solar;
      document.getElementById("t1").value = e.t1;
      document.getElementById("t2").value = e.t2;
      document.getElementById("t3").value = e.t3;
      document.getElementById("export").value = e.export;
      entries.splice(i, 1);
      updateStorage();
      renderEntries();
    }

    // Backup Readings
    function backupReadings() {
      const data = { initialReadings, entries };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `solar_diary_backup_${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Restore Readings
    function restoreReadings() {
      const fileInput = document.getElementById('restoreFile');
      const file = fileInput.files[0];
      if (!file) {
        alert('Please select a JSON file to restore.');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (data.initialReadings) {
            initialReadings = data.initialReadings;
            localStorage.setItem('initialReadings', JSON.stringify(initialReadings));
          }
          if (data.entries) {
            entries = data.entries;
            localStorage.setItem('entries', JSON.stringify(entries));
          }
          displayInitialValues();
          renderEntries();
          alert('Readings restored successfully!');
        } catch (err) {
          alert('Error restoring readings: Invalid JSON file.');
        }
      };
      reader.readAsText(file);
      fileInput.value = '';
    }

    // Generate Printable Report
    function generatePrintableReport() {
      window.print();
    }

    displayInitialValues();
    renderEntries();
  </script>
</body>
</html>
